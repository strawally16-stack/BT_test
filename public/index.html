<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Braintree + PayPal (Commit + App Switch)</title>

    <script src="https://js.braintreegateway.com/web/3.134.0/js/client.min.js"></script>
    <script src="https://js.braintreegateway.com/web/3.134.0/js/paypal-checkout.min.js"></script>
  </head>

  <body>
    <h1>Pay with PayPal</h1>

    <div id="paypal-button-container"></div>
    <pre id="log"></pre>

    <script>
      const AMOUNT = "100.00";
      const CURRENCY = "GBP";

      // ⚠️ MUST be real HTTPS (ngrok or production domain)
      const RETURN_URL = "https://bt-test-b4tq.onrender.com";
      const CANCEL_URL = "https://bt-test-b4tq.onrender.com";

      const log = (msg) =>
        (document.getElementById("log").textContent += msg + "\n");

      async function main() {
        const clientToken = await fetch("/client_token").then((r) => r.text());

        const clientInstance = await braintree.client.create({
          authorization: clientToken,
        });

        const paypalCheckoutInstance =
          await braintree.paypalCheckout.create({
            client: clientInstance,
          });

        paypalCheckoutInstance.loadPayPalSDK(
          {
            components: "buttons",
            currency: CURRENCY,
            intent: "capture",
            // drop commit: true
          },
          function () {

         function createOrder() {
  const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

  const opts = {
  flow: "checkout",
  amount: AMOUNT,
  currency: CURRENCY,
  intent: "capture",
  userAction: "commit",   // lowercase
};

  if (isMobile) {
    opts.returnUrl = 'https://bt-test-b4tq.onrender.com';
    opts.cancelUrl = 'https://bt-test-b4tq.onrender.com';
    opts.appSwitchPreference = {
      launchPaypalApp: true,
    };
  }

  console.log("createPayment opts:", opts);

  return paypalCheckoutInstance.createPayment(opts);
}

            function handleApprove(data) {
              return paypalCheckoutInstance.tokenizePayment(
                data,
                async function (err, payload) {
                  if (err) {
                    log("Tokenize error: " + err.message);
                    return;
                  }

                  log("Nonce: " + payload.nonce);

                  const resp = await fetch("/checkout", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                      payment_method_nonce: payload.nonce,
                      amount: AMOUNT,
                      currency: CURRENCY,
                    }),
                  });

                  const result = await resp.json();

                  if (result.ok) {
                    log("Transaction ID: " + result.transactionId);
                  } else {
                    log("Server error: " + result.error);
                  }
                }
              );
            }

            const buttons = paypal.Buttons({
              fundingSource: paypal.FUNDING.PAYPAL,
              createOrder,
              onApprove: handleApprove,
              onCancel: () => log("Buyer cancelled"),
              onError: (err) => {
                console.error("PayPal error:", err);
                log("PayPal error: " + err.message);
              },
            });

            if (typeof buttons.hasReturned === "function" && buttons.hasReturned()) {
              log("Resuming App Switch...");
              buttons.resume();
            } else {
              buttons.render("#paypal-button-container");
            }
          }
        );
      }

      main().catch((e) => {
        console.error(e);
        log("Init error: " + e.message);
      });
    </script>
  </body>
</html>