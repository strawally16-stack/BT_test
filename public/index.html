<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Braintree + PayPal (Shipping + Contact + Pay Later)</title>

    <script src="https://js.braintreegateway.com/web/3.134.0/js/client.min.js"></script>
    <script src="https://js.braintreegateway.com/web/3.134.0/js/paypal-checkout.min.js"></script>
  </head>

  <body>
    <h1>PayPal / Pay Later</h1>

    <!-- Pay Later messaging (optional but recommended) -->
    <div
      data-pp-message
      data-pp-layout="text"
      data-pp-text-color="black"
      data-pp-logo-type="inline"
      data-pp-amount="100.00"
    ></div>

    <div id="paypal-button"></div>
    <div id="pay-later-button" style="margin-top: 12px;"></div>

    <pre id="log"></pre>

    <script>
      const AMOUNT = "100.00";
      const CURRENCY = "GBP";

      const log = (msg) => (document.getElementById("log").textContent += msg + "\n");

      async function main() {
        const clientToken = await fetch("/client_token").then((r) => r.text());

        const clientInstance = await braintree.client.create({ authorization: clientToken });
        const paypalCheckoutInstance = await braintree.paypalCheckout.create({ client: clientInstance });

        // Pay Later guide: must include components=buttons,messages and dataAttributes.amount for Pay Later button :contentReference[oaicite:5]{index=5}
        paypalCheckoutInstance.loadPayPalSDK(
          {
            components: "buttons,messages",
            "buyer-country": "GB",
            currency: CURRENCY,
            intent: "capture",
            "enable-funding": "paylater",
            dataAttributes: { amount: AMOUNT },
          },
          function () {
            function createOrder() {
              // One-time Payments: createPayment() options; add Contact Module + Shipping callback URL :contentReference[oaicite:6]{index=6}
             const createPaymentRequestOptions = {
              flow: "checkout",
              amount: AMOUNT,
              currency: CURRENCY,
              intent: "capture",
              // REMOVE shippingCallbackUrl for now
              // REMOVE shippingAddressOverride for now (add back after base flow works)
            };
            return paypalCheckoutInstance.createPayment(createPaymentRequestOptions);

            }

            async function handleApprove(data) {
              return paypalCheckoutInstance.tokenizePayment(data, async function (err, payload) {
                if (err) {
                  console.error(err);
                  log("Tokenize error: " + err.message);
                  return;
                }

                log("Nonce: " + payload.nonce);

                const resp = await fetch("/checkout", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    payment_method_nonce: payload.nonce,
                    amount: AMOUNT,
                  }),
                });

                const result = await resp.json();
                if (result.ok) log("Transaction ID: " + result.transactionId);
                else log("Server error: " + (result.error || JSON.stringify(result)));
              });
            }

            // Optional: client-side listener for shipping changes.
            // If you need to recalc totals on address/option change, you can call your server and then use
            // paypalCheckoutInstance.updatePayment (Braintree docs note updatePayment replaces actions.order.patch) :contentReference[oaicite:10]{index=10}
            async function onShippingChange(data, actions) {
              try {
                const resp = await fetch("/shipping/reprice", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ data }),
                });
                const updated = await resp.json();

                // Update the PayPal flow with updated shipping/totals
                await paypalCheckoutInstance.updatePayment(updated);

                return actions.resolve();
              } catch (e) {
                console.error(e);
                return actions.reject();
              }
            }

            // PayPal button
            paypal
              .Buttons({
                fundingSource: paypal.FUNDING.PAYPAL,
                createOrder,
                onApprove: handleApprove,
                onShippingChange, // optional (see notes above)
                onCancel: (data) => log("Cancelled: " + JSON.stringify(data, null, 2)),
                onError: (err) => log("PayPal error: " + err.message),
              })
              .render("#paypal-button");

            // Standalone Pay Later button (Pay Later guide) :contentReference[oaicite:11]{index=11}
            const payLaterButton = paypal.Buttons({
              fundingSource: paypal.FUNDING.PAYLATER,
              createOrder,
              onApprove: handleApprove,
              onShippingChange, // optional
            });

            if (payLaterButton.isEligible()) {
              payLaterButton.render("#pay-later-button");
            } else {
              log("Pay Later button not eligible for this buyer/context.");
            }
          }
        );
      }

      main().catch((e) => {
        console.error(e);
        log("Init error: " + e.message);
      });
    </script>
  </body>
</html>
